<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Head content remains unchanged -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Aagneya Dashboard</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/css/bootstrap-select.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        [x-cloak] {
            display: none
        }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <script src="//unpkg.com/alpinejs" defer></script>
</head>

<body>
    <!-- Sidebar and navbar remain unchanged -->
    <div class="sidebar">
        <a href="#" class="logo">
            <i class='bx bx-code-alt'></i>
            <div class="logo-name"><span>Aag</span>neya</div>
        </a>
        <ul class="side-menu">
            <li><a href="./dashboard.html"><i class='bx bxs-dashboard'></i>Dashboard</a></li>
            <li><a href="./event.html"><i class='bx bx-calendar-event'></i>Events</a></li>
            <li><a href="./achievement.html"><i class='bx bx-medal'></i>Achievement</a></li>
            <li><a href="#"><i class='bx bx-news'></i>Blog</a></li>
            <li><a href="./user.html"><i class='bx bx-group'></i>Users</a></li>
            <li class="active"><a href="#" class="toggle-submenu" data-target="community"><i class='bx bx-category-alt'></i>Community <i class='bx bx-chevron-down'></i> </a> </li>
            <ul class="submenu" id="community-submenu">
                <li><a href="./community/voting.html"><i class='bx bxl-graphql'></i>Stats</a></li>
                <li><a href="./community/president.html"><i class='bx bx-crown'></i>President</a></li>
                <li><a href="./community/vicepresident.html"><i class='bx bx-star'></i>Vice President</a></li>
                <li><a href="./community/secretary.html"><i class='bx bx-notepad'></i>Secretary</a></li>
                <li><a href="./community/publicrelation.html"><i class='bx bx-broadcast'></i>Public Relation</a></li>
            </ul>
            <li><a href="./editProfile.html"><i class='bx bx-cog'></i>Settings</a></li>
        </ul>
        <ul class="side-menu">
            <li>
                <a href="#" class="logout">
                    <a href="#" class="logout" onclick="logout()"><i class='bx bx-log-out-circle'></i> Logout </a>
                </a>
            </li>
        </ul>
    </div>
    <!-- End of Sidebar -->

    <div class="content">
        <!-- Navbar -->
        <nav>
            <i class='bx bx-menu'></i>
            <form action="#">
                <div class="form-input">
                    <button style="background-color: transparent; color: #1976d2; width: fit-content;">Hi , <span id="name"> Name</span></button>
                </div>
            </form>
            <input type="checkbox" id="theme-toggle" hidden>
            <a href="#" class="notif">
                <i class='bx bx-bell'></i>
                <span class="count">12</span>
            </a>
        </nav>

        <main>
            <div class="header">
                <h1 class="text-xl font-bold mb-4">Profile Management</h1>
                <!-- ... -->
            </div>

            <div class="bottom-data">
                <div class="orders bg-white rounded-lg shadow-md p-6">
                    <div class="profile-container">
                        <div class="profile-content flex flex-col md:flex-row items-start gap-8">
                            <div class="profile-image w-full md:w-1/3">
                                <!-- Card Component -->
                                <div class="card w-full max-w-sm overflow-hidden bg-white rounded-lg shadow-lg" id="profileCard">
                                    <img class="object-cover object-center w-full" id="profileCardImage" src="https://upload.wikimedia.org/wikipedia/commons/4/43/1500x1500-abstract-sd2003.jpg" alt="Profile Picture">
                                    <div class="flex items-center justify-between px-6 py-3 bg-gray-900">
                                        <div class="flex items-center">
                                            <i class="fas fa-crown text-yellow-500"></i>
                                            <h1 class="mx-3 text-lg font-semibold text-white">Vice Captain</h1>
                                        </div>
                                    </div>
                                </div>
                                <span id="imageWarning" class="text-red-500 hidden mt-2">The image must be 1:1 ratio.</span>
                                <span id="fileTypeWarning" class="text-red-500 hidden mt-2">Only JPG or JPEG images are allowed.</span>
                            </div>
                            <div class="profile-details w-full md:w-2/3">
                                <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="editName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                        <input type="text" id="editName" name="editName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="" readonly>
                                    </div>
                                    <div>
                                        <label for="editEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="editEmail" name="editEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="" readonly>
                                    </div>
                                    <div>
                                        <label for="editPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input type="tel" id="editPhone" name="editPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="" readonly>
                                    </div>
                                    <div>
                                        <label for="editDOB" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                                        <input type="date" id="editDOB" name="editDOB" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="" readonly>
                                    </div>
                                    <!-- <div>
                                        <label for="editDepartment" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                                        <input type="text" id="editDepartment" name="editDepartment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="Computer Science" readonly>
                                    </div>
                                    <div>
                                        <label for="editYear" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                                        <input type="text" id="editYear" name="editYear" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="3rd Year" readonly>
                                    </div> -->
                                    <div>
                                        <label for="editImage" class="block text-sm font-medium text-gray-700 mb-1">Profile Image</label>
                                        <input type="file" id="editImage" name="editImage" accept="image/jpeg, image/jpg" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" disabled>
                                    </div>
                                </form>
                                <div class="mt-6 flex space-x-4">
                                    <button id="editProfileBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out">Edit Profile</button>
                                    <button id="saveProfileBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out hidden">Save</button>
                                    <button id="cancelEditBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
                                </div>
                            </div>
                        </div>
                        <hr class="mt-6 mb-4">
                        <!-- Reset Password Section -->
                        <div class="reset-password-container">
                            <h1 class="text-xl font-bold mb-4">Reset Password</h1>
                            <form id="resetPasswordForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="relative">
                                    <label for="oldPassword" class="block text-sm font-medium text-gray-700 mb-1">Old Password</label>
                                    <input type="password" id="oldPassword" name="oldPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <i class="fas fa-eye eye-icon absolute right-3 top-10 cursor-pointer" onclick="togglePasswordVisibility('oldPassword')"></i>
                                </div>
                                <div class="relative">
                                    <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                    <input type="password" id="newPassword" name="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <i class="fas fa-eye eye-icon absolute right-3 top-10 cursor-pointer" onclick="togglePasswordVisibility('newPassword')"></i>
                                </div>
                                <div class="relative">
                                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                    <input type="password" id="confirmPassword" name="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <i class="fas fa-eye eye-icon absolute right-3 top-10 cursor-pointer" onclick="togglePasswordVisibility('confirmPassword')"></i>
                                </div>
                            </form>
                            <div class="mt-6">
                                <button id="resetPasswordBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out">Reset Password</button>
                            </div>
                        </div>
                        <hr class="mt-6 mb-4">
                        <!-- Security Questions Section -->
                        <div class="security-questions-container">
                            <h1 class="text-xl font-bold mb-4">Security Questions</h1>
                            <form id="securityQuestionsForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h1 class="block text-sm font-medium text-gray-700 mb-1">1. What is the name of the city where you were born?</h1>
                                    <input type="text" id="firstSchool" name="firstSchool" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="Answer" readonly>
                                </div>
                                <div>
                                    <h1 class="block text-sm font-medium text-gray-700 mb-1">2. What was the name of your elementary school?</h1>
                                    <input type="text" id="favoriteFood" name="favoriteFood" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="Answer" readonly>
                                </div>
                                <div>
                                    <h1 class="block text-sm font-medium text-gray-700 mb-1">3. What is the name of your favorite childhood friend?</h1>
                                    <input type="text" id="bestFriend" name="bestFriend" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="Answer" readonly>
                                </div>
                            </form>
                            <div class="mt-6 flex space-x-4">
                                <button id="editSecurityQuestionsBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out">Edit Security Questions</button>
                                <button id="saveSecurityQuestionsBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out hidden">Save</button>
                                <button id="cancelSecurityQuestionsBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <!-- JavaScript for the toggling functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Profile Management Section
            const editProfileBtn = document.getElementById('editProfileBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const profileForm = document.getElementById('profileForm');
            const profileInputs = document.querySelectorAll('#profileForm input');
            const editImage = document.getElementById('editImage');
            const imageWarning = document.getElementById('imageWarning');
            const fileTypeWarning = document.getElementById('fileTypeWarning');
            const profileCardImage = document.getElementById('profileCardImage');

            let validImage = false;

            editProfileBtn.addEventListener('click', function() {
                profileInputs.forEach(input => {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                });
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.remove('hidden');
            });

            cancelEditBtn.addEventListener('click', function() {
                profileInputs.forEach(input => {
                    input.setAttribute('readonly', 'readonly');
                    input.setAttribute('disabled', 'disabled');
                });
                editProfileBtn.classList.remove('hidden');
                saveProfileBtn.classList.add('hidden');
                cancelEditBtn.classList.add('hidden');
                imageWarning.classList.add('hidden');
                fileTypeWarning.classList.add('hidden');
                profileForm.reset(); // Reset form to original values
                validImage = false;
                disprofile()
            });

            editImage.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const img = new Image();
                    img.onload = function() {
                        if (this.width !== this.height) {
                            imageWarning.classList.remove('hidden');
                            validImage = false;
                            editImage.value = ''; // Clear the file input
                        } else {
                            imageWarning.classList.add('hidden');
                            validImage = true;
                            // Update profile card image preview
                            profileCardImage.src = img.src;
                        }
                    }
                    img.src = URL.createObjectURL(file);

                    const fileType = file.type;
                    if (fileType !== 'image/jpeg' && fileType !== 'image/jpg') {
                        fileTypeWarning.classList.remove('hidden');
                        validImage = false;
                        editImage.value = ''; // Clear the file input
                    } else {
                        fileTypeWarning.classList.add('hidden');
                    }
                }
            });

            saveProfileBtn.addEventListener('click', function() {
                if (!validImage && editImage.files.length > 0) {
                    alert('Please upload a valid 1:1 ratio image.');
                    return;
                }

                const formData = new FormData(profileForm);
                console.log('Profile data saved:', Object.fromEntries(formData));

                // Reset form state
                profileInputs.forEach(input => {
                    input.setAttribute('readonly', 'readonly');
                    input.setAttribute('disabled', 'disabled');
                });
                editProfileBtn.classList.remove('hidden');
                saveProfileBtn.classList.add('hidden');
                cancelEditBtn.classList.add('hidden');
                imageWarning.classList.add('hidden');
                fileTypeWarning.classList.add('hidden');
                validImage = false;
            });

            // Password Reset Section
            const resetPasswordBtn = document.getElementById('resetPasswordBtn');
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const resetPasswordInputs = resetPasswordForm.querySelectorAll('input');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const passwordError = document.createElement('p');
            passwordError.classList.add('text-red-500', 'mt-2', 'hidden');
            confirmPasswordInput.parentNode.appendChild(passwordError);

            resetPasswordBtn.addEventListener('click', function() {
                if (resetPasswordBtn.textContent === 'Reset Password') {
                    resetPasswordInputs.forEach(input => {
                        input.removeAttribute('readonly');
                    });
                    resetPasswordBtn.textContent = 'Submit';
                } else {
                    if (newPasswordInput.value !== confirmPasswordInput.value) {
                        passwordError.textContent = "Passwords do not match";
                        passwordError.classList.remove('hidden');
                        return;
                    }

                    const formData = new FormData(resetPasswordForm);
                    console.log('Password reset data saved:', Object.fromEntries(formData));

                    resetPasswordInputs.forEach(input => {
                        input.setAttribute('readonly', 'readonly');
                        input.value = '';
                    });
                    resetPasswordBtn.textContent = 'Reset Password';
                    passwordError.classList.add('hidden');
                }
            });

            // Security Questions Section
            const editSecurityQuestionsBtn = document.getElementById('editSecurityQuestionsBtn');
            const saveSecurityQuestionsBtn = document.getElementById('saveSecurityQuestionsBtn');
            const cancelSecurityQuestionsBtn = document.getElementById('cancelSecurityQuestionsBtn');
            const securityInputs = document.querySelectorAll('#securityQuestionsForm input');

            editSecurityQuestionsBtn.addEventListener('click', function() {
                securityInputs.forEach(input => {
                    input.removeAttribute('readonly');
                });
                editSecurityQuestionsBtn.classList.add('hidden');
                saveSecurityQuestionsBtn.classList.remove('hidden');
                cancelSecurityQuestionsBtn.classList.remove('hidden');
            });

            cancelSecurityQuestionsBtn.addEventListener('click', function() {
                securityInputs.forEach(input => {
                    input.setAttribute('readonly', 'readonly');
                });
                editSecurityQuestionsBtn.classList.remove('hidden');
                saveSecurityQuestionsBtn.classList.add('hidden');
                cancelSecurityQuestionsBtn.classList.add('hidden');
            });

            saveSecurityQuestionsBtn.addEventListener('click', function() {
                const formData = new FormData(document.getElementById('securityQuestionsForm'));
                console.log('Security questions data saved:', Object.fromEntries(formData));

                securityInputs.forEach(input => {
                    input.setAttribute('readonly', 'readonly');
                });
                editSecurityQuestionsBtn.classList.remove('hidden');
                saveSecurityQuestionsBtn.classList.add('hidden');
                cancelSecurityQuestionsBtn.classList.add('hidden');
            });
        });

        function togglePasswordVisibility(passwordId) {
            const passwordField = document.getElementById(passwordId);
            const eyeIcon = passwordField.nextElementSibling;
            if (passwordField.type === "password") {
                passwordField.type = "text";
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = "password";
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }
    </script>

    <div id="loading-spinner" class="hidden">
        <svg aria-hidden="true" class="w-8 h-8 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
    </svg>
        <span class="sr-only">Loading...</span>
    </div>

    <style>
        #loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.7);
            /* Semi-transparent background */
            z-index: 9999;
            /* Make sure it's on top */
            position: fixed;
            /* Fixed position to cover the screen */
            inset: 0;
            /* Cover the entire viewport */
        }
        
        .hidden {
            display: none;
        }
    </style>


</body>

</html>

<script src="./js/index.js"></script>


<script>
    let roll_no;
    let name;
    let token;

    async function decodeToken() {
        const spinner = document.getElementById('loading-spinner');
        spinner.style.display = 'flex'; // Show the spinner
        try {
            token = localStorage.getItem('token');
            console.log('Token from localStorage:', token);

            if (!token) {
                console.error('Token not found in local storage');
                window.location.href = '../login/login.html';
                return;
            }

            const response = await fetch('https://aagneya-backend.onrender.com/api/decodeToken', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    token: token
                })
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Decoded token data:', data);

                roll_no = data.roll_no;
                name = data.name;

                if (data.is_active === 1) {
                    if (data.role_id == 0) {
                        console.log("Hello admin");

                        const nameElement = document.getElementById('name');
                        nameElement.textContent = name;
                        disprofile();

                    } else {
                        window.location.href = '../User Dashboard/dashboard.html';
                    }
                } else {
                    console.error('User is not active');
                    window.location.href = '../login/login.html';
                }

            } else {
                console.error('Failed to decode token:', response.statusText);
                window.location.href = '../login/login.html';
            }
        } catch (error) {
            console.error('Error in decodeToken:', error.message);
            window.location.href = '../login/login.html';
        } finally {
            spinner.style.display = 'none'; // Hide the spinner
        }
    }

    async function disprofile() {
        const spinner = document.getElementById('loading-spinner');
        spinner.style.display = 'flex'; // Show the spinner
        try {
            const response = await fetch('https://aagneya-backend.onrender.com/api/displaymem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    roll_no: roll_no
                })
            });

            if (response.ok) {
                const data = await response.json();
                console.log('User data:', data);

                const profile = data[0];

                // Populate the form inputs with fetched data
                document.getElementById('editName').value = profile.name;
                document.getElementById('editEmail').value = profile.email;
                document.getElementById('editPhone').value = profile.phone;
                // Assuming profile.date is the date of birth in ISO format (e.g., "1990-01-01")
                document.getElementById('editDOB').value = profile.date ? profile.date.slice(0, 10) : 'Unknown';

                const profileImagePath = profile.photo_path ? `https://aagneya-backend.onrender.com/${profile.photo_path}` : 'https://example.com/default-profile-image.jpg';
                document.getElementById('profileCardImage').src = profileImagePath;

            } else {
                throw new Error(`Failed to fetch profile: ${response.statusText}`);
            }
        } catch (error) {
            console.error('Error fetching profile:', error);
        } finally {
            spinner.style.display = 'none'; // Hide the spinner
        }
    }

    window.onload = function() {
        decodeToken();
    };
</script>

<script>
    function logout() {
        // Remove token from local storage
        localStorage.removeItem('token');

        // Redirect to index.html
        window.location.href = '../login/login.html';
    }
</script>